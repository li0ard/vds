import { describe, test, expect } from "bun:test";
import { ICAOBarcode, Seal, Signer, Verifier } from "../src";
import { brainpoolP256r1 } from "@noble/curves/misc.js";

const utts5bPublicKey = Buffer.from("0408132A7243B3CCC29C271097081C96A729EEFB8EB93630E536498E9B7CE1CED25D68A789D93BEF39C04715C5AD3915D281C0754ECC08508BF66687EFC630DF88", "hex");
const verifier = new Verifier(brainpoolP256r1, utts5bPublicKey);

const testPrivateKey = Buffer.from("548350533aa2507817ebb50a7ee8db0840d1177c932deaa1168f7f7dff311ef2", "hex");
const testPublicKey = brainpoolP256r1.getPublicKey(testPrivateKey, false);
const testSigner = new Signer(brainpoolP256r1, testPrivateKey);
const testVerifier = new Verifier(brainpoolP256r1, testPublicKey);

describe("Signing/verifying (VDS)", () => {
    test("#1 (v4)", () => {
        const seal = Buffer.from("dc03d9c5d9cac8a73a990f7134b83459fb0602305cba135875976ec066d417b59e8c6abc133c133c133c133c3fef3a2938ee43f1593d1ae52dbb26751fe64b7c133c136b0306d79519a65306ff40a1f621437b25e0dc6177182297c47544890177ebd0e89b1d1ec9f994ed6fe60e5561fac9bc9e723ff8f60c679f6a23b938ee6584f852476f8c72a05e3f9eb87e", "hex");
        const decodedSeal = Seal.decode(seal);

        expect(verifier.verifySeal(decodedSeal)).toBeTrue();

        decodedSeal.signature = testSigner.signSeal(decodedSeal);
        expect(verifier.verifySeal(decodedSeal)).not.toBeTrue();
        expect(testVerifier.verifySeal(decodedSeal)).toBeTrue();
    });

    test("#2 (v3)", () => {
        const seal = Buffer.from("dc02d9c5d9cac8a51a780f7134b83459fd020230a56213535bd4caecc87ca4ccaeb4133c133c133c133c133c3fef3a2938ee43f1593d1ae52dbb26751fe64b7c133c136b030859e9203833736d24ff40a353a998b785470536187860093d55325a06e66fe917bfa1f6fb62c5016c66a481ec6f2c7c18da9682f0c2e0b592f6eeb11ca6c6994b37ca2950d6fadd63264d", "hex");
        const decodedSeal = Seal.decode(seal);

        expect(verifier.verifySeal(decodedSeal)).toBeTrue();

        decodedSeal.signature = testSigner.signSeal(decodedSeal);
        expect(verifier.verifySeal(decodedSeal)).not.toBeTrue();
        expect(testVerifier.verifySeal(decodedSeal)).toBeTrue();
    });
});

describe("Signing/verifying (IDB)", () => {
    test("#1", () => {
        const barcode = "RDB1BNK6ADJL2PECXOABAHIMWDAQEE6ATAXHCCNJVXVGK5TEHZJGMV22BGPATHQJTYEZ4CM6D73Z2FE4O4Q7RLE6RVZJNXMTHKH7GJN6BGPATNOAIEA7EAAAAADDKKAQCADIKQ4FAAAAACRTHI6LQNJYDEIAAAAAAA2TQGIQAAAAAI5VHAMTIAAAAAFTJNBSHEAAAACAQAAAAMQAACBYHAAAAAAAAB5RW63DSAEAAAAAAAAIQAAAADJZGK4ZAAAAAAETSMVZWGAJMAD7ACLAA7YCAIAAAAAAGU4BSMP7U772RAAUQAAAAAAAGIAAAACAQAAAAAAAAAAAAAAAAAZAAAAAICAAAAAAAAAAAAAAACBYBAH7VYAAXIJTTKZ2MM5GGOZCGGZDDMRVMHYED4CB5UP7VEAAMAAAAAAIAAMCAIAAA75SAADQAAFGFIX2KKAZF6MRSG37ZAAAKAAAAAAADB4AAD74TY7FX6HL6CBIU4OROHXUXWYFSZTVXFI47EE2NADZRJWKVIGHF7BZDEJUHKDBB2LVVJBUG6MCWD66UJDQPTNHAIKTKEB4THMTRBKM6ORXIEW5WWVQDEYMMIFHA43M5OEHWK62OQHQQKTBLBNONJTM3INJTFMRPXM6NUTBYIQWXPHK6EMENBL25ZRIW5FXG2PZO3CLJC6WCXCLFGNZKYPSKOQ7EULA7BVUAKBQ44Q6HCLT5RDUZM4D3TT55GA7H57NQ7G7LXSG4W4NNAT344KM5LE7EMSDFOE5OFQDYF6PQYZRXR3RQSBCDGV34YNJG3VUWGUJ3DL7TJAYWW7YVI5GVGPX4IKM25DFVEAGB6OM2VFHQAGMFNJFT56I7V5XIRMFOIFJDG2SRS5GFCKY6UUYUVPBL3TG2ULE6ULYNIICKTLUJK6ALUA2SNNU7TSPBXVQVRPEJ7R7UHJWBWI6XGNKWRRBXEFB27VLV3OEVKMVQBCLRFUWXFYXFVOWMF7I763YAUQXDNTP7E42DG26XKBB4HYG4UPR3NQONHCMQKS5FOZOP6JDW75G5EPKRLSGBURBIMMLAW72X4TTXLFH5ATDGB4VCA6US4G57CFEPCE6SB6JUZJGDLWTD2L7YLDXCTYPXZYSMPITJV5ABIDRACHAYDBJZXQXWIPCWWX6TVPXTIA6MQQJNAVSETK7IYNK6NXA66V2A6UELOCCMQDDEKQYNOCLDZ2NGWSIRQFODRERJXLTKFZ2PIUHF34VJDGYKAAFN67I2WUVWD2UY3FOBWKVU5YXMYV5FRRN6DWNJWA76JYR2ONQ72CZHBHYBTN7XNRGVNVRMMT7DZLUXZPOA2HA46H6ADOTMVJTNWAG6SENPRKH4SJQZWGSFXXFGP4P6Q3J5NSRFZZBLFGHVFGLQIYB5VGSHBBE2YEXIPMP4XGND45NCNSKOJIN6LIT4ZQO2QXRWLOX6BY7QNMEHHI4A5VUX54LSUSASKQRNZUREAU2IATUK5OYDB3XGQTZBHZC3SHGSQJPCRSBJVFG72WXX6RN2R34JFPYXVPUKMEM55ZTGXLR76AJR2TPT7HKGO6RTEIDE6RBFNRKJRR4NPILHJ5XLUEMZKB4A65NSF6T2YN3Y3T4EXDIQCQ3XQ2N7ERQQKZYWTTVPVCNFAJMMNE4JXNFCY4FRH27KA5P3LWZGCF4TIPXSWR2QZESM4AOSH74XRORBXWWCTS3VO4CW6Q773GBQQWPJEA4DG43NESDACDL7IAMCPPDIBKASGQN6J33WNDV5AEUMHRVFM356VZI257XMJLSEMMKNWFLHF3LRKFTDGUEM3VQO3BWTJYWJXSVBHTXMRA6MUPHGLK623RV5";
        const decodedBarcode = ICAOBarcode.decode(barcode);

        decodedBarcode.payload.signature = testSigner.signBarcode(decodedBarcode);
        expect(verifier.verifyBarcode(decodedBarcode)).not.toBeTrue();
        expect(testVerifier.verifyBarcode(decodedBarcode)).toBeTrue();
    });

    test("#2", () => {
        const barcode = "RDB1BNK6ADJL2PECXOABAHIMWCFMCAYQDQM3TI2XIGCCZ5EQDQM3TNUSIMAIQP5AIZJ6II7FQTQ2UNWUMTMXIXETVCSSXKBK7RFWGXX3JBLHXTPV26M2GBN42UWTEQB45P4C4X7JK5WI2VQW5IBV3YNDPHELTYIU54PQ4P4";
        const decodedBarcode = ICAOBarcode.decode(barcode);

        decodedBarcode.payload.signature = testSigner.signBarcode(decodedBarcode);
        expect(verifier.verifyBarcode(decodedBarcode)).not.toBeTrue();
        expect(testVerifier.verifyBarcode(decodedBarcode)).toBeTrue();
    });
});